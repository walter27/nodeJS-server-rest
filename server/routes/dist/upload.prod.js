"use strict";function _defineProperty(r,o,e){return o in r?Object.defineProperty(r,o,{value:e,enumerable:!0,configurable:!0,writable:!0}):r[o]=e,r}var express=require("express"),fileUpload=require("express-fileupload"),app=express(),Usuario=require("../models/usuario"),Producto=require("../models/producto"),fs=require("fs"),path=require("path");function imagenUsuario(r,e,s){Usuario.findById(r,function(r,o){return r?(borrarArchivo(s,"usuarios"),e.status(500).json({ok:!1,err:r})):o?(borrarArchivo(o.img,"usuarios"),o.img=s,void o.save(function(r,o){e.json({ok:!0,usuario:o,img:s})})):(borrarArchivo(s,"usuarios"),e.status(400).json({ok:!1,err:{message:"Usuario no existe"}}))})}function imagenProducto(r,e,s){Producto.findById(r,function(r,o){return r?(borrarArchivo(s,"productos"),e.status(500).json({ok:!1,err:r})):o?(borrarArchivo(o.img,"productos"),o.img=s,void o.save(function(r,o){e.json({ok:!0,producto:o,img:s})})):(borrarArchivo(s,"productos"),e.status(400).json({ok:!1,err:{message:"Producto no existe"}}))})}function borrarArchivo(r,o){var e=path.resolve(__dirname,"../../uploads/".concat(o,"/").concat(r));fs.existsSync(e)&&fs.unlinkSync(e)}app.use(fileUpload()),app.put("/upload/:tipo/:id",function(r,o){var e=r.params.tipo,s=r.params.id;if(!r.files)return o.status(400).json({oh:!1,err:{message:"No se ha selecionado ningun archivo"}});var i=["productos","usuarios"];if(i.indexOf(e)<0)return o.status(400).json({ok:!1,err:{message:"los tipos permitidos son "+i.join(", ")}});var a=r.files.archivo,n=a.name.split("."),t=n[n.length-1],u=["png","jpg","gif","jpg"];if(u.indexOf(t)<0)return o.status(400).json({ok:!1,err:{message:"las extensiones permitidas son "+u.join(", "),ext:t}});var c="".concat(s,"-").concat((new Date).getMilliseconds(),".").concat(t);a.mv("../uploads/".concat(e,"/").concat(c),function(r){if(r)return o.status(500).json(_defineProperty({err:!1},"err",r));"usuarios"===e?imagenUsuario(s,o,c):imagenProducto(s,o,c)})}),module.exports=app;