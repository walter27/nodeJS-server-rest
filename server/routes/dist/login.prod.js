"use strict";var express=require("express"),app=express(),Usuario=require("../models/usuario"),bcrypt=require("bcrypt"),jwt=require("jsonwebtoken"),_require=require("google-auth-library"),OAuth2Client=_require.OAuth2Client,client=new OAuth2Client(process.env.CLIENT_ID);function verify(r){var n,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(client.verifyIdToken({idToken:r,audience:process.env.CLIENT_ID}));case 2:return n=e.sent,s=n.getPayload(),e.abrupt("return",{nombre:s.name,email:s.email,img:s.picture,google:!0});case 5:case"end":return e.stop()}})}app.post("/login",function(e,s){var o=e.body;Usuario.findOne({email:o.email},function(e,r){if(e)return s.status(500).json({ok:!1,err:e});if(!r)return s.status(400).json({ok:!1,err:{message:"(Usuario) o contraseña incorretos"}});if(!bcrypt.compareSync(o.password,r.password))return s.status(400).json({ok:!1,err:{message:"Usuario o (contraseña) incorretos"}});var n=jwt.sign({usuario:r},process.env.SEED,{expiresIn:process.env.CADUCIDAD_TOKEN});s.json({ok:!0,usuario:r,token:n})})}),app.post("/google",function(r,o){var n,t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.body.idtoken,e.next=3,regeneratorRuntime.awrap(verify(n).catch(function(e){o.status(403).json({ok:!1,error:e})}));case 3:t=e.sent,Usuario.findOne({email:t.email},function(e,r){if(e)return o.status(500).json({ok:!1,err:e});if(r){if(!1===r.google)return o.status(400).json({ok:!1,err:{message:"Debe usar su autenticacion normal"}});var n=jwt.sign({usuario:r},process.env.SEED,{expiresIn:process.env.CADUCIDAD_TOKEN});return o.json({ok:!0,usuario:r,token:n})}var s=new Usuario;s.nombre=t.nombre,s.email=t.email,s.img=t.img,s.google=!0,s.password=":)",s.save(function(e,r){if(e)return o.status(400).json({ok:!1,error:e});var n=jwt.sign({usuario:r},process.env.SEED,{expiresIn:process.env.CADUCIDAD_TOKEN});return o.json({ok:!0,usuario:r,token:n})})});case 5:case"end":return e.stop()}})}),module.exports=app;